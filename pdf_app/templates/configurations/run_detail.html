{% extends 'base/base.html' %}

{% block title %}Run Results | PDF Template Builder{% endblock %}

{% block extra_css %}
<style>
    pre.json {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.375rem;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.875rem;
        line-height: 1.25rem;
        overflow-x: auto;
    }
    
    .blinking {
        animation: blinker 1.5s linear infinite;
    }
    
    @keyframes blinker {
        50% {
            opacity: 0.5;
        }
    }
</style>
{% endblock %}

{% block content %}
<div>
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div>
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-indigo-100 rounded-md p-2 mr-4">
                    <i class="fas fa-file-alt text-indigo-600 text-xl"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-900">
                    Run Results
                </h1>
                <span class="ml-4 px-2.5 py-0.5 rounded-full text-xs font-medium 
                    {% if run.status == 'completed' %}bg-green-100 text-green-800
                    {% elif run.status == 'failed' %}bg-red-100 text-red-800
                    {% elif run.status == 'running' %}bg-blue-100 text-blue-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ run.get_status_display }}
                </span>
            </div>
            <p class="mt-2 text-lg text-gray-600">
                Results from processing {{ run.document.title }} with {{ run.configuration.name }}.
            </p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="{% url 'configuration_detail' run.configuration.id %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-arrow-left mr-2"></i> Back to Configuration
            </a>
        </div>
    </div>
    
    {% if messages %}
    <div class="mb-8">
        {% for message in messages %}
        <div class="rounded-md p-4 {% if message.tags == 'success' %}bg-green-50 text-green-800{% elif message.tags == 'error' %}bg-red-50 text-red-800{% else %}bg-blue-50 text-blue-800{% endif %} shadow-sm" role="alert">
            <div class="flex">
                <div class="flex-shrink-0">
                    {% if message.tags == 'success' %}
                    <i class="fas fa-check-circle text-green-400"></i>
                    {% elif message.tags == 'error' %}
                    <i class="fas fa-exclamation-circle text-red-400"></i>
                    {% else %}
                    <i class="fas fa-info-circle text-blue-400"></i>
                    {% endif %}
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium">{{ message }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Run Details -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md mb-8">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
                Run Information
            </h3>
        </div>
        <div class="border-t border-gray-200">
            <dl>
                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">
                        Configuration
                    </dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <a href="{% url 'configuration_detail' run.configuration.id %}" class="text-indigo-600 hover:text-indigo-900">
                            {{ run.configuration.name }}
                        </a>
                    </dd>
                </div>
                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">
                        Document
                    </dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <a href="{% url 'document_detail' run.document.id %}" class="text-indigo-600 hover:text-indigo-900">
                            {{ run.document.title }}
                        </a>
                    </dd>
                </div>
                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">
                        Started At
                    </dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        {{ run.started_at|date:"F j, Y, g:i a" }}
                    </dd>
                </div>
                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">
                        Status
                    </dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if run.status == 'completed' %}bg-green-100 text-green-800
                            {% elif run.status == 'failed' %}bg-red-100 text-red-800
                            {% elif run.status == 'running' %}bg-blue-100 text-blue-800 blinking
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ run.get_status_display }}
                        </span>
                        {% if run.completed_at %}
                        <span class="ml-2 text-gray-500">
                            (Completed in {{ run.completed_at|timeuntil:run.started_at }})
                        </span>
                        {% endif %}
                    </dd>
                </div>
            </dl>
        </div>
    </div>
    
    {% if run.status == 'failed' %}
    <!-- Error Message -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md mb-8">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
                Error Details
            </h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="rounded-md bg-red-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">
                            Processing Failed
                        </h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>{{ run.error_message }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if run.status == 'running' %}
    <!-- Processing Status -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md mb-8">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
                Processing Status
            </h3>
        </div>
        <div class="px-4 py-5 sm:p-6 text-center">
            <div class="animate-pulse">
                <i class="fas fa-cog fa-spin text-indigo-500 text-6xl mb-4"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">Processing in progress</h3>
            <p class="mt-1 text-sm text-gray-500">The configuration is currently running. This page will refresh automatically.</p>
        </div>
    </div>
    {% endif %}
    
    {% if run.status == 'completed' %}
    <!-- Results Section -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md mb-8">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
                Extraction Results
            </h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500">
                Structured data extracted from the document.
            </p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            {% if run.results %}
            <pre class="json" id="results-json">{{ run.results }}</pre>
            {% else %}
            <p class="text-sm text-gray-500 italic">No results data available.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Actions Section -->
    <div class="bg-white shadow overflow-hidden sm:rounded-md mb-8">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
                Actions
            </h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                <div>
                    <a href="{% url 'configuration_run_download' run.id %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-file-download mr-2"></i> Download Results (JSON)
                    </a>
                </div>
                <div>
                    <a href="{% url 'configuration_run_download_csv' run.id %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-file-csv mr-2"></i> Download Results (CSV)
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Back to Configuration button -->
    <div class="mt-8 flex justify-start">
        <a href="{% url 'configuration_detail' run.configuration.id %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Configuration
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Format JSON display
        const resultsJson = document.getElementById('results-json');
        if (resultsJson) {
            try {
                const results = JSON.parse(resultsJson.textContent);
                resultsJson.textContent = JSON.stringify(results, null, 2);
            } catch (e) {
                console.error('Invalid JSON in results');
            }
        }
        
        // Auto-refresh for running status
        {% if run.status == 'running' %}
        setTimeout(function() {
            window.location.reload();
        }, 5000); // Refresh every 5 seconds
        {% endif %}
    });
</script>
{% endblock %} 